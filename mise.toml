[tasks.build]
run = [{tasks = [
  "site:build_events",
  "site:clean",
  "site:render",
  "site:sync",
  "site:fix_cname"
]}]

[tasks."site:build_events"]
description = "Generate qmd files from _events/*"
run = """
./app/quarto_builder.py future > ./site/index.qmd
./app/quarto_builder.py past > ./site/past.qmd
"""

[tasks."site:clean"]
description = "Rebuild from scratch, every time."
run = "rm -rf ./docs/*"

[tasks."site:render"]
dir = "./site"
run = "quarto render"
depends = ["site:clean", "site:build_events"]

[tasks."site:sync"]
run = "rsync -a ./site/_docs/ ./docs/"
depends = ["site:render"]

[tasks."site:fix_cname"]
description = "Quarto render blows away ./docs/cname, we must restore it for github pages to function."
run = "git checkout ./docs/CNAME"
depends = ["site:sync"]

[tasks.ssh]
run = "ssh admin@$(tart ip dev)"

[tasks.hack]
description = "Run dev VM and SSH in"
run = """
set -euo pipefail

VM=dev
USER=admin

# start VM in background
tart run "$VM" --no-graphics \
  --dir "app:$(pwd):tag=com.apple.virtio-fs.automount" \
  --dir "secure:../fitvk.secure:tag=com.apple.virtio-fs.automount" &

VM_PID=$!

cleanup() {
  kill "$VM_PID" >/dev/null 2>&1 || true
}
trap cleanup EXIT

# wait for IP
for _ in {1..60}; do
  IP="$(tart ip "$VM" 2>/dev/null || true)"
  [ -n "$IP" ] && break
  sleep 1
done

if [ -z "${IP:-}" ]; then
  echo "VM never got an IP"
  exit 1
fi

# wait for sshd
for _ in {1..60}; do
  if nc -z "$IP" 22 2>/dev/null; then
    break
  fi
  sleep 1
done

# exec replaces the shell so ctrl-d exits cleanly
exec ssh -o StrictHostKeyChecking=no \
         -o UserKnownHostsFile=/dev/null \
         "$USER@$IP"
"""

[tools]
uv = "latest"
