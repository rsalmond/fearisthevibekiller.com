[env]
CONTAINER_RUNTIME = "nerdctl"
CONTAINER_RUNTIME_SUDO = "sudo"
COMPOSE_FILE = "compose.yaml"
SECRET_DIR = "/secure/"
COMPOSE_RUN_FLAGS = "--interactive=false"

[tasks.go]
description = "Fetch, classify, extract, and cut PRs"
run = [{tasks = [
  "app:run",
  "app:pr-events"
]}]

[tasks."app:build"]
description = "Build the application container image."
run = "${CONTAINER_RUNTIME_SUDO} ${CONTAINER_RUNTIME} compose build app"
sources = [
  "app/Dockerfile",
  "app/requirements.txt",
  "app/**/*.py"
]

[tasks."app:test"]
description = "Run unit tests inside the application container."
depends = ["app:build"]
run = "${CONTAINER_RUNTIME_SUDO} ${CONTAINER_RUNTIME} compose run --rm ${COMPOSE_RUN_FLAGS} --entrypoint python app -m unittest discover -s /app/tests"

[tasks."app:progress"]
description = "Show pipeline progress."
depends = ["app:build"]
run = "${CONTAINER_RUNTIME_SUDO} ${CONTAINER_RUNTIME} compose run --rm ${COMPOSE_RUN_FLAGS} --entrypoint python app /app/main.py progress"

[tasks."app:fetch"]
description = "Fetch new posts for configured accounts."
depends = ["app:build"]
run = "${CONTAINER_RUNTIME_SUDO} ${CONTAINER_RUNTIME} compose run --rm ${COMPOSE_RUN_FLAGS} --entrypoint python app /app/main.py fetch --accounts /app/data/accounts.txt"

[tasks."app:classify"]
description = "Classify posts as event listings."
depends = ["app:build"]
run = "${CONTAINER_RUNTIME_SUDO} ${CONTAINER_RUNTIME} compose run --rm ${COMPOSE_RUN_FLAGS} --entrypoint python app /app/main.py classify-events"

[tasks."app:extract"]
description = "Extract event metadata and render templates."
depends = ["app:build"]
run = "${CONTAINER_RUNTIME_SUDO} ${CONTAINER_RUNTIME} compose run --rm ${COMPOSE_RUN_FLAGS} -e LOG_LEVEL=INFO --entrypoint python app /app/main.py extract-events"

[tasks."app:run"]
description = "Run fetch, classify, and extraction in sequence."
depends = ["app:build"]
run = "${CONTAINER_RUNTIME_SUDO} ${CONTAINER_RUNTIME} compose run --rm ${COMPOSE_RUN_FLAGS} --entrypoint python app /app/main.py run --accounts /app/data/accounts.txt"

[tasks."app:pr-events"]
description = "Create one PR per new rendered event QMD file."
run = """
set -euo pipefail
set -a
. ${SECRET_DIR}.env
set +a
python3 ./scripts/create_event_prs.py
"""

[tasks."site:build_events"]
description = "Generate qmd files from _events/*"
run = """
./app/quarto_builder.py future > ./site/index.qmd
./app/quarto_builder.py past > ./site/past.qmd
"""

[tasks."site:build"]
description = "Run the entire site build and render process."
run = [{tasks = [
  "site:build_events",
  "site:clean",
  "site:render",
  "site:sync",
  "site:fix_cname"
]}]

[tasks."site:clean"]
description = "Rebuild from scratch, every time."
run = "rm -rf ./docs/*"

[tasks."site:render"]
dir = "./site"
run = "quarto render"
depends = ["site:clean", "site:build_events"]

[tasks."site:sync"]
run = "rsync -a ./site/_docs/ ./docs/"
depends = ["site:render"]

[tasks."site:fix_cname"]
description = "Quarto render blows away ./docs/cname, we must restore it for github pages to function."
run = "git checkout ./docs/CNAME"
depends = ["site:sync"]

[tasks."dev:ssh"]
run = "ssh admin@$(tart ip dev)"

[tasks."dev:hack"]
description = "Run dev VM and SSH in"
run = """
set -euo pipefail

VM=dev
USER=admin

# start VM in background
tart run "$VM" --no-graphics \
  --dir "app:$(pwd):tag=com.apple.virtio-fs.automount" \
  --dir "secure:../fitvk.secure:tag=com.apple.virtio-fs.automount" &

VM_PID=$!

cleanup() {
  kill "$VM_PID" >/dev/null 2>&1 || true
}
trap cleanup EXIT

# wait for IP
for _ in {1..60}; do
  IP="$(tart ip "$VM" 2>/dev/null || true)"
  [ -n "$IP" ] && break
  sleep 1
done

if [ -z "${IP:-}" ]; then
  echo "VM never got an IP"
  exit 1
fi

# wait for sshd
for _ in {1..60}; do
  if nc -z "$IP" 22 2>/dev/null; then
    break
  fi
  sleep 1
done

# exec replaces the shell so ctrl-d exits cleanly
exec ssh -o StrictHostKeyChecking=no \
         -o UserKnownHostsFile=/dev/null \
         "$USER@$IP"
"""

[tools]
gh = "latest"
uv = "latest"
